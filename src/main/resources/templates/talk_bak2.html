<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Chat Room</title>
    <style>
        /* 기존 스타일은 그대로 유지 */
        #chatArea {
            width: 50%;
            height: 300px;
            overflow-y: auto;
            border: 1px solid #ccc;
            margin-bottom: 10px;
            padding: 10px;
            font-family: Arial, sans-serif;
            background-color: #f9f9f9;
        }

        .message {
            margin: 5px 0;
            display: flex;
            align-items: center;
        }

        .bubble {
            padding: 10px;
            border-radius: 10px;
            max-width: 60%;
            color: #fff;
            word-wrap: break-word;
        }

        .bubble.creator {
            background-color: #007bff;  /* 방 개설자의 말풍선 색 (파란색) */
            float: left;
        }

        .bubble.other {
            background-color: #28a745;  /* 다른 사용자의 말풍선 색 (녹색) */
            float: right;
        }

        .progress {
            width: 100%;
            background-color: #f3f3f3;
            border-radius: 5px;
            margin-top: 10px;
            display: none; /* 기본적으로 숨김 */
        }

        .progress-bar {
            width: 0%;
            height: 20px;
            background-color: #4caf50;
            border-radius: 5px;
        }
    </style>
</head>
<body>
<h2>Chat Room: [[${roomName}]]</h2>

<input type="text" id="usernameInput" placeholder="Enter your name" />
<button id="joinButton">Join Room</button>

<div id="chatContainer" style="display:none;">
    <!-- 채팅 메시지를 표시할 div -->
    <div id="chatArea"></div><br>
    <textarea id="messageInput" placeholder="Type a message..." rows="3"></textarea>
    <button id="sendButton">Send</button>
    <br><br>

    <!-- 파일 선택 -->
    <input type="file" id="fileInput" />
    <button id="sendFileButton">Send File</button>

    <!-- Progress Bar 추가 -->
    <div class="progress" id="progressBar">
        <div class="progress-bar" id="progressBarFill"></div>
    </div>

    <!-- Download Link 추가 -->
    <a id="downloadLink" style="display: none;">Download File</a>
</div>

<script>
    var roomId = '[[${roomId}]]';  // roomId에 싱글 쿼테이션 추가
    var webSocket;
    var username = ''; // 사용자 이름을 저장할 변수
    var isCreator = false; // 방 개설자인지 여부
    //const CHUNK_SIZE = 8 * 1024;  // 16KB 크기로 파일을 나눔
    //const CHUNK_SIZE = 16 * 1024;  // 16KB 크기로 파일을 나눔
    const CHUNK_SIZE = 32 * 1024;  // 16KB 크기로 파일을 나눔
    //const CHUNK_SIZE = 64 * 1024;  // 16KB 크기로 파일을 나눔

    var progressBar = document.getElementById("progressBar");
    var progressBarFill = document.getElementById("progressBarFill");
    var downloadLink = document.getElementById("downloadLink");
    var receivedChunks = [];  // 수신된 chunk를 저장할 배열
    var totalChunks = 0;      // 전체 chunk 수
    var currentChunk = 0;     // 현재 수신 중인 chunk 인덱스

    // 랜덤 문자열 생성 함수
    function generateRandomString(length, isUppercase) {
        const characters = isUppercase ? 'ABCDEFGHIJKLMNOPQRSTUVWXYZ' : 'abcdefghijklmnopqrstuvwxyz';
        let result = '';
        for (let i = 0; i < length; i++) {
            result += characters.charAt(Math.floor(Math.random() * characters.length));
        }
        return result;
    }

    // 페이지 로드 시 랜덤한 사용자 이름을 입력 필드에 설정
    window.onload = function() {
        const usernameInput = document.getElementById('usernameInput');
        const randomUsername = generateRandomString(6, false);  // 소문자 6글자 사용자 이름 생성
        usernameInput.value = randomUsername;
    };

    // 대화방에 입장 버튼 클릭 이벤트
    document.getElementById("joinButton").addEventListener("click", function() {
        username = document.getElementById("usernameInput").value.trim();
        if (username) {
            if (webSocket && webSocket.readyState === WebSocket.OPEN) {
                console.warn("Already connected to a WebSocket.");
                return; // 이미 연결된 경우 중지
            }
            webSocket = new WebSocket('ws://localhost:8080/chat/' + roomId);

            webSocket.binaryType = 'arraybuffer';


            document.getElementById("chatContainer").style.display = "block"; // 채팅 컨테이너 표시

            // WebSocket이 연결되면 사용자 이름을 전송
            webSocket.onopen = function() {
                console.log(username + ' has joined the room.');

                // 방 개설자인지 확인
                if (document.getElementById("chatArea").children.length === 0) {
                    isCreator = true;
                }
            };

            // WebSocket 오류 처리
            webSocket.onerror = function(event) {
                console.error("WebSocket error observed:", event);
            };

            // WebSocket 닫힘 처리
            webSocket.onclose = function(event) {
                console.log("WebSocket connection closed:", event);
            };

            // 메시지 수신
            webSocket.onmessage = function(event) {
                var chatArea = document.getElementById("chatArea");
                var data = '';
                try{
                    data = JSON.parse(event.data);
                }catch(e){  //if (data instanceof Blob) {
                    data = {
                        type: 'file'
                    };
                }

                if (data.type == 'file' ||data.type =='fileMeta') {
                    // 로그 추가 - 메시지 수신 시
                    //console.log("Message received from " + data.username + ": " + data.file);

                    if(data.type == 'fileMeta'){
                        console.log("data.totalChunks ::" + data.totalChunks);
                        console.log("data.chunkIndex ::" + data.chunkIndex);
                        totalChunks = data.totalChunks;
                        if(data.chunkIndex >= data.totalChunks){
                            // 모든 chunk 수신 완료
                            var completeFile = new Blob(receivedChunks);
                            var downloadUrl = URL.createObjectURL(completeFile);  // Blob을 URL로 변환

                            // 다운로드 링크 설정
                            downloadLink.href = downloadUrl;
                            downloadLink.download = data.fileName;  // 파일 이름 설정
                            downloadLink.style.display = 'block';  // 다운로드 링크 표시
                            downloadLink.innerHTML = 'Download File'+data.fileName;  // 링크 텍스트 설정

                            // 진행률 숨기기
                            progressBar.style.display = 'none';
                            console.log("File received successfully.");
                            currentChunk = 0;
                            totalChunks = 0;
                        }
                    }else{
                        currentChunk++;
                        //console.log("Message received from " + new Uint8Array(event.data));
                        receivedChunks.push(new Uint8Array(event.data));

                        // 진행률 표시
                        var progress = (currentChunk / totalChunks) * 100;
                        console.log("progress::"+progress);
                        progressBar.style.display = 'block';
                        progressBarFill.style.width = progress + '%';
                    }


                } else {
                    // 로그 추가 - 메시지 수신 시
                    console.log("Message received from " + data.username + ": " + data.message);
                    var messageBubble = document.createElement('div');

                    // 방 개설자와 다른 사용자 구분
                    var bubbleClass = data.username === username && isCreator ? 'creator' : 'other';
                    messageBubble.className = 'message ' + bubbleClass;

                    var bubble = document.createElement('div');
                    bubble.className = 'bubble ' + bubbleClass;
                    bubble.innerText = data.username + ": " + data.message;

                    messageBubble.appendChild(bubble);
                    chatArea.appendChild(messageBubble);
                    chatArea.scrollTop = chatArea.scrollHeight; // 스크롤을 항상 맨 아래로 이동
                }
            };

            // 메시지 전송 함수
            function sendMessage() {
                var messageInput = document.getElementById("messageInput");
                var message = messageInput.value.trim();

                if (message) {
                    var data = {
                        messageType: 'chat',
                        username: username,
                        message: message
                    };

                    // 로그 추가 - 메시지 전송 시
                    console.log("Message sent by " + username + ": " + message);

                    // WebSocket 연결 상태 확인 후 메시지 전송
                    if (webSocket.readyState === WebSocket.OPEN) {
                        webSocket.send(JSON.stringify(data));  // WebSocket을 통해 JSON 형태로 전송
                    } else {
                        console.error("WebSocket is not open. Message not sent.");
                    }

                    messageInput.value = '';  // 입력 필드 초기화
                }
            }

            // "Send" 버튼에 클릭 이벤트 리스너 추가
            document.getElementById("sendButton").addEventListener("click", sendMessage);

            // Enter 키를 눌렀을 때 메시지 전송
            document.getElementById("messageInput").addEventListener("keypress", function(event) {
                if (event.key === "Enter" && !event.shiftKey) {
                    event.preventDefault();  // 줄 바꿈 방지
                    sendMessage();  // 메시지 전송
                }
            });

            // 파일 전송 버튼 클릭 이벤트
            document.getElementById("sendFileButton").addEventListener("click", function() {
                var fileInput = document.getElementById("fileInput");
                var file = fileInput.files[0]; // 사용자가 선택한 파일

                if (file) {
                    var reader = new FileReader();
                    var offset = 0;  // 현재 읽고 있는 파일의 오프셋
                    totalChunks = Math.ceil(file.size / CHUNK_SIZE); // 전체 chunk 수 계산

                    // 파일 읽기 완료 시
                    reader.onload = function(event) {
                        //var chunkData = new Uint8Array(event.target.result);  // 현재 chunk 데이터
                        var chunkData = event.target.result;  // 현재 chunk 데이터


                        // WebSocket 연결 상태 확인 후 chunk 전송
                        if (webSocket.readyState === WebSocket.OPEN) {
                            webSocket.send(chunkData);
                        } else {
                            console.error("WebSocket is not open. File chunk not sent.");
                        }

                        offset += CHUNK_SIZE;  // 다음 chunk를 읽기 위한 오프셋 증가

                        // 진행률 표시
                        var progress = (offset / file.size) * 100;
                        progressBar.style.display = 'block';
                        progressBarFill.style.width = progress + '%';

                        // 다음 chunk가 있으면 계속 읽기
                        if (offset < file.size) {
                            readChunk();  // 다음 chunk 읽기
                        } else {
                            if (webSocket.readyState === WebSocket.OPEN) {
                                console.log("file meta send last...");
                                webSocket.send(JSON.stringify({
                                    type: 'fileMeta',
                                    username: username,
                                    fileName: file.name,
                                    totalChunks: totalChunks,
                                    chunkIndex: Math.floor(offset / CHUNK_SIZE)  // chunk 인덱스 계산
                                }));
                            }
                            console.log("File upload complete.");
                            progressBar.style.display = 'none';  // 진행률 숨기기
                        }
                    };

                    // chunk 읽기 함수
                    function readChunk() {
                        var blob = file.slice(offset, offset + CHUNK_SIZE);  // 파일의 특정 범위 자르기
                        reader.readAsArrayBuffer(blob);  // 잘라낸 범위를 ArrayBuffer로 읽기
                    }

                    //파일binary전송하기전에 meta정보전송
                    if (webSocket.readyState === WebSocket.OPEN) {
                        console.log("file meta send first...");
                        webSocket.send(JSON.stringify({
                            type: 'fileMeta',
                            username: username,
                            fileName: file.name,
                            totalChunks: totalChunks,
                            chunkIndex: Math.floor(offset / CHUNK_SIZE)  // chunk 인덱스 계산
                        }));
                    }
                    readChunk();  // 첫 번째 chunk 읽기 시작
                } else {
                    alert('Please select a file first.');  // 파일이 선택되지 않은 경우 경고 메시지
                }
            });
        } else {
            alert("Please enter your name.");
        }
    });
</script>
</body>
</html>
